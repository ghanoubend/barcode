<!DOCTYPE html>
<html>
<head>
    <title>Lecteur de codes-barres</title>
    <script src="https://cdn.jsdelivr.net/npm/quagga"></script>
</head>
<body>
    <h1>Lecteur de codes-barres</h1>
    <div id="barcode-scanner"></div>
    <button id="verify-button">Vérifier le code-barres</button>
    <div id="code-barre-input"></div>
    <div id="message"></div>
    <div id="result"></div>

    <script>

        const container= document.getElementById('result');


        // Configuration de QuaggaJS
        Quagga.init(
      {
        inputStream: {
          type: "LiveStream",
          target: document.getElementById('barcode-scanner'),
          constraints: {
            width: 640,
            height: 480,
          },
          numOfWorkers : navigator.hardwareConcurrency,
        },
        decoder: {
          readers: [ 
          "code_39_reader","ean_reader"
            ], 
        },
      },
      function (err) {
        if (err) {
          console.error(err);
          return;
        }
        console.log('Initialization finished, Ready to start');
        Quagga.start();
      
      }
    );
        
        
       var last_result = [];
    Quagga.onDetected((result) => {
            const codeBarre = result.codeResult.code;
            console.log("Code-barres détecté : " + codeBarre);
last_result.push(codeBarre);

if (last_result.length >= 30){

  code = maxoccurence(last_result);
   container.innerHTML=code;
   document.getElementById("code-barre-input").value = codeBarre;
   Quagga.stop();
          
}
           
       });

        

        
        

        // Lorsque le bouton "Vérifier le code-barres" est cliqué
        document.getElementById("verify-button").addEventListener("click", () => {
            const codeBarre = document.getElementById("code-barre-input").value;

            // Envoyez le code-barres au serveur pour vérification
            fetch("http://votreserveur.com/checkBarcode", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ codeBarre }),
            })
            .then((response) => response.json())
            .then((data) => {
                const messageElement = document.getElementById("message");
                if (data.found) {
                    if (data.status === true) {
                        messageElement.textContent = "Code-barre trouvé et jamais utilisé.";
                    } else {
                        messageElement.textContent = "Code-barre trouvé mais déjà utilisé.";
                    }
                } else {
                    messageElement.textContent = "Code-barre non trouvé.";
                }
            })
            .catch((error) => {
                console.error("Une erreur s'est produite :", error);
            });
        });

  function maxoccurence(liste) {
 
  const compteur = {};


  liste.forEach(numero => {
    if (compteur[numero]) {
      compteur[numero]++;
    } else {
      compteur[numero] = 1;
    }
  });

  let nombrePlusFrequent;
  let occurencesMax = 0;

  for (const numero in compteur) {
    if (compteur[numero] > occurencesMax) {
      occurencesMax = compteur[numero];
      nombrePlusFrequent = numero;
    }
  }

  return nombrePlusFrequent;
  
}
        
    </script>
</body>
</html>